<!--
build.xml

Ant build file for VisBio project.
Download Apache Ant from http://ant.apache.org/.
Type "ant -p" for a list of targets.
-->

<project name="visbio" default="jar" basedir=".">
  <description>
    Build file for VisBio project
  </description>
  <property file="base.properties"/>
  <import file="${root.dir}/java.xml"/>
  <property file="build.properties"/>

  <target name="dist"
    depends="dist-win32, dist-win32-nojre, dist-macosx, dist-linux, dist-nojre"
    description="create distribution bundles for VisBio"/>

  <target name="dist-win32" depends="jar"
    description="create distribution bundle: Windows w/ JRE">
    <copy todir="${visbio.dist-win32-dir}/VisBio" preservelastmodified="true">
      <fileset dir="dist/win32"/>
      <fileset dir="${dest.dir}/loci/visbio"
        includes="${visbio.dist-resources}"/>
      <fileset dir="${artifact.dir}" includes=
        "${component.jar} ${component.manifest-cp} ${visbio.dist-jars}"/>
    </copy>
    <fixcrlf srcdir="${visbio.dist-win32-dir}/VisBio"
      eol="dos" includes="${visbio.dist-text-files}"/>
    <untar src="${root.dir}/dist/jre-win32.tar.gz"
      dest="${visbio.dist-win32-dir}/VisBio"
      overwrite="false" compression="gzip"/>
    <zip destfile="${dist.dir}/visbio${visbio.version}_win32.zip"
      basedir="${visbio.dist-win32-dir}"/>
  </target>

  <target name="dist-win32-nojre" depends="jar"
    description="create distribution bundle: Windows no JRE">
    <copy todir="${visbio.dist-win32-nojre-dir}/VisBio"
      preservelastmodified="true">
      <fileset dir="dist/win32" excludes="launcher.cfg"/>
      <fileset dir="dist/win32-nojre"/>
      <fileset dir="${dest.dir}/loci/visbio"
        includes="${visbio.dist-resources}"/>
      <fileset dir="${artifact.dir}" includes=
        "${component.jar} ${component.manifest-cp} ${visbio.dist-jars}"/>
    </copy>
    <fixcrlf srcdir="${visbio.dist-win32-nojre-dir}/VisBio"
      eol="dos" includes="${visbio.dist-text-files}"/>
    <zip destfile="${dist.dir}/visbio${visbio.version}_win32_nojre.zip"
      basedir="${visbio.dist-win32-nojre-dir}"/>
  </target>

  <!-- HACK - limit OS to *nix due to file permission issues -->
  <target name="dist-macosx" if="isUnix" depends="jar"
    description="create distribution bundle: Mac OS X">
    <copy todir="${visbio.dist-macosx-dir}/VisBio"
      preservelastmodified="true">
      <fileset dir="dist/macosx"/>
      <fileset dir="${dest.dir}/loci/visbio"
        includes="${visbio.dist-resources}"/>
    </copy>
    <fixcrlf srcdir="${visbio.dist-macosx-dir}/VisBio"
      eol="mac" includes="${visbio.dist-text-files}"/>
    <!-- HACK - copy does not preserve permissions; chmod them back -->
    <chmod perm="+x">
      <fileset dir="${visbio.dist-macosx-dir}/VisBio"
        includes="${visbio.exec-macosx}"/>
    </chmod>
    <copy todir=
      "${visbio.dist-macosx-dir}/VisBio/VisBio.app/Contents/Resources/Java">
      <fileset dir="${artifact.dir}" includes=
        "${component.jar} ${component.manifest-cp} ${visbio.dist-jars}"/>
    </copy>
    <!--<tar destfile="${dist.dir}/visbio${visbio.version}_macosx.tar.gz"
      basedir="${visbio.dist-macosx-dir}" compression="gzip"/>-->
    <!-- HACK - tar does not preserve permissions; use exec instead -->
    <echo>Building tar: visbio${visbio.version}_macosx.tar.gz</echo>
    <exec executable="tar">
      <arg value="czf"/>
      <arg value="${dist.dir}/visbio${visbio.version}_macosx.tar.gz"/>
      <arg value="-C"/>
      <arg value="${visbio.dist-macosx-dir}"/>
      <arg value="VisBio"/>
    </exec>
  </target>

  <!-- HACK - limit OS to *nix due to file permission issues -->
  <target name="dist-linux" if="isUnix"
    depends="jar"
    description="create distribution bundle: Linux w/ JRE">
    <copy todir="${visbio.dist-linux-dir}/visbio${visbio.version}"
      preservelastmodified="true">
      <fileset dir="dist/linux"/>
      <fileset dir="${dest.dir}/loci/visbio"
        includes="${visbio.dist-resources}"/>
      <fileset dir="${artifact.dir}" includes=
        "${component.jar} ${component.manifest-cp} ${visbio.dist-jars}"/>
    </copy>
    <fixcrlf srcdir="${visbio.dist-linux-dir}/visbio${visbio.version}"
      eol="unix" includes="${visbio.dist-text-files}"/>
    <!-- HACK - copy does not preserve permissions; chmod them back -->
    <chmod perm="+x">
      <fileset dir="${visbio.dist-linux-dir}/visbio${visbio.version}"
        includes="${visbio.exec-linux}"/>
    </chmod>
    <!--<untar src="${root.dir}/dist/jre-linux.tar.gz"
      dest="${visbio.dist-linux-dir}/visbio${visbio.version}"
      overwrite="false" compression="gzip"/>-->
    <!-- HACK - untar does not restore permissions; use exec instead -->
    <echo>Expanding: jre-linux.tar.gz</echo>
    <exec executable="tar">
      <arg value="xzf"/>
      <arg value="${root.dir}/dist/jre-linux.tar.gz"/>
      <arg value="-C"/>
      <arg value="${visbio.dist-linux-dir}/visbio${visbio.version}"/>
    </exec>
    <!--<tar destfile="${dist.dir}/visbio${visbio.version}_linux.tar.gz"
      basedir="${visbio.dist-linux-dir}" compression="gzip"/>-->
    <!-- HACK - tar does not preserve permissions; use exec instead -->
    <echo>Building tar: visbio${visbio.version}_linux.tar.gz</echo>
    <exec executable="tar">
      <arg value="czf"/>
      <arg value="${dist.dir}/visbio${visbio.version}_linux.tar.gz"/>
      <arg value="-C"/>
      <arg value="${visbio.dist-linux-dir}"/>
      <arg value="visbio${visbio.version}"/>
    </exec>
  </target>

  <!-- HACK - limit OS to *nix due to file permission issues -->
  <target name="dist-nojre" if="isUnix" depends="jar"
    description="create distribution bundle: cross-platform">
    <copy todir="${visbio.dist-nojre-dir}/visbio${visbio.version}"
      preservelastmodified="true">
      <fileset dir="dist/linux"/>
      <fileset dir="${dest.dir}/loci/visbio"
        includes="${visbio.dist-resources}"/>
      <fileset dir="${artifact.dir}" includes=
        "${component.jar} ${component.manifest-cp} ${visbio.dist-jars}"/>
    </copy>
    <fixcrlf srcdir="${visbio.dist-nojre-dir}/visbio${visbio.version}"
      eol="unix" includes="${visbio.dist-text-files}"/>
    <!-- HACK - copy does not preserve permissions; chmod them back -->
    <chmod perm="+x">
      <fileset dir="${visbio.dist-nojre-dir}/visbio${visbio.version}"
        includes="${visbio.exec-linux}"/>
    </chmod>
    <!--<tar destfile="${dist.dir}/visbio${visbio.version}.tar.gz"
      basedir="${visbio.dist-nojre-dir}" compression="gzip"/>-->
    <!-- HACK - tar does not preserve permissions; use exec instead -->
    <echo>Building tar: visbio${visbio.version}.tar.gz</echo>
    <exec executable="tar">
      <arg value="czf"/>
      <arg value="${dist.dir}/visbio${visbio.version}.tar.gz"/>
      <arg value="-C"/>
      <arg value="${visbio.dist-nojre-dir}"/>
      <arg value="visbio${visbio.version}"/>
    </exec>
  </target>
</project>
